# 가계부 자금흐름 시스템 기능정의서

## 1. 목적
- 그룹 단위로 월 기준일에 맞춰 자금흐름(입금/출금)을 집계한다.
- 자산 및 입출금 내역을 관리하고, WebSMS 수신으로 자동 반영한다.

## 2. 시스템 구성
- API: Node.js + Express
- DB: PostgreSQL
- UI: 정적 HTML/CSS/JS
- 배포: Docker Compose (API + DB)
- 접속 포트: `8081`

## 3. 사용자/인증
### 3.1 회원가입
- 입력: 아이디(`username`), 비밀번호(`password`)
- 비밀번호 정책: 영문/숫자/특수문자 포함 10자 이상
- 중복 아이디는 가입 불가

### 3.2 로그인/세션
- 성공 시 쿠키 발급
  - Access Token: 1시간
  - Refresh Token: 7일
- API 호출이 401일 경우 `/auth/refresh`로 갱신 후 재시도

### 3.3 계정 관리
- 상단 고정 헤더에서 아이디 메뉴 제공
- 비밀번호 변경 / 회원 탈퇴

### 3.4 WebSMS API 키
- 회원가입 시 사용자별 API 키 발급
- WebSMS 수신 시 `x-api-key`로 인증

## 4. 그룹/권한
- 역할: `admin`, `user`
- 사용자는 여러 그룹에 속할 수 있음
- 활성 그룹(active group)을 기준으로 데이터 조회
- 그룹별 월 기준일(`month_start_day`) 설정
- 권한 단위: 자산, 입출금, 요약
  - 관리자가 사용자별 권한 및 그룹 소속을 설정

## 5. 자산 관리
- 자산 등록/조회/수정/삭제
- 자산 유형: `cash`, `account`, `card`, `loan`
- 주요 필드: 자산명, 발행기관, 자산번호, 현재 잔액
- WebSMS 필터(`filter_text`)
  - 콤마로 구분한 문자열이 모두 포함되면 해당 자산에 매칭
- 비활성화(숨김)
  - 비활성화 시 필터가 제거되어 WebSMS 매칭에서 제외
  - 기존 입출금 내역은 유지

## 6. 입출금 관리
- 등록/조회/수정/삭제
- 구분: `deposit`(입금) / `withdraw`(출금)
- 카드/대출에는 추가 필드 사용
  - 원금, 할부 개월, 이자율
- 조회 정렬: 최신순
- 기간 조회
  - 시작/종료일 필터
  - 기본 범위는 그룹 월 기준일에 맞춘 월 구간
- 잔액 반영
  - WebSMS 처리 시 자산 잔액 자동 반영
  - 입출금 수동 등록/수정은 잔액 자동 반영 없음
  - 입출금 삭제 시 잔액을 역반영

## 7. 요약(메인)
- 월 기준일에 따른 기간의 입금/출금 합계를 요약
- 잔액 = 입금 합계 - 출금 합계

## 8. WebSMS 수신
- 수신 API: `POST /websms`
- 인증: `x-api-key` (사용자 API 키)
- 처리 흐름
  - 메시지 원문 저장(`websms_logs`)
  - 필터 매칭된 자산이 1개일 때만 자동 처리
  - 매칭/파싱 성공 시 입출금 내역 생성 및 잔액 반영
  - 실패 시 `unmatched`로 저장

### 8.1 미분류(WebSMS)
- 미분류 목록 페이지 제공
- 미분류 메시지 삭제 가능
  - 현재는 로그 테이블에서도 삭제

### 8.2 관리자 WebSMS 로그
- 그룹별 WebSMS 로그 조회

## 9. 관리자 기능
- 사용자 목록 조회
- 사용자 역할/권한/그룹 소속 수정
- 그룹 관리 및 월 기준일 설정
- 그룹 요약 조회
- WebSMS 로그 조회
- 트랜잭션 감사 로그 조회

## 10. 트랜잭션 감사 로그
- 생성/수정/삭제 시 기록
- 기록 항목: 누가, 언제, 어떤 변경이 있었는지

## 11. API 목록
### 인증
- `POST /auth/register`
- `POST /auth/login`
- `POST /auth/refresh`
- `POST /auth/logout`
- `GET /auth/me`
- `GET /auth/groups`
- `PUT /auth/active-group`
- `POST /auth/change-password`
- `POST /auth/delete-account`

### 자산
- `GET /assets`
- `POST /assets`
- `PUT /assets/:id`
- `PUT /assets/:id/hidden`
- `DELETE /assets/:id`

### 입출금
- `GET /transactions`
- `POST /transactions`
- `PUT /transactions/:id`
- `DELETE /transactions/:id`

### 요약
- `GET /summary`

### WebSMS
- `POST /websms`
- `GET /websms/unmatched`
- `POST /websms/unmatched/:id/ignore`

### 관리자
- `GET /admin/users`
- `PUT /admin/users/:id/permissions`
- `GET /admin/groups`
- `POST /admin/groups`
- `PUT /admin/groups/:id/start-day`
- `GET /admin/group-summary`
- `GET /admin/websms-logs`
- `GET /admin/transaction-logs`

## 12. 데이터 모델(요약)
- users: id, username, password_hash, role, active_group_id
- refresh_tokens: user_id, token_hash, expires_at, revoked_at
- user_permissions: user_id, can_view_assets, can_view_transactions, can_view_summary
- groups: id, name
- user_group_access: user_id, group_id
- group_settings: group_id, month_start_day, updated_at
- user_api_keys: user_id, api_key
- assets: group_id, name, issuer, asset_number, asset_type, current_balance_cents, filter_text, hidden
- transactions: group_id, asset_id, user_id, direction, amount_cents, memo, occurred_at
- websms_logs: group_id, asset_id, received_at, text_preview, text, status
- transaction_logs: transaction_id, group_id, user_id, action, before_data, after_data

## 13. 운영/배포
- Docker Compose로 API/DB 구동
- 외부 접속 포트: `8081`
- DB 변경은 `migrations/` 기준으로 관리
