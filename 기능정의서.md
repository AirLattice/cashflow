# 가계부 자금흐름 시스템 기능정의서

## 1. 목적
- 가정의 월별 고정 지출과 수입을 관리하여 수입 대비 지출 감당 가능 여부를 확인한다.
- 고정 지출을 월별로 집계하고, 월별 수입 합계와 비교하여 잔액을 제공한다.

## 2. 시스템 구성
- API: Node.js + Express
- DB: PostgreSQL
- UI: 단일 페이지 웹 UI (정적 HTML/CSS/JS)
- 배포: Docker Compose (API + DB)
- 접속 포트: `8081`

## 3. 사용자/인증
### 3.1 회원가입
- 입력: 아이디(`username`), 비밀번호(`password`)
- 비밀번호 정책: 영문/숫자/특수문자 포함 10자 이상
- 중복 아이디는 가입 불가

### 3.2 로그인
- 입력: 아이디, 비밀번호
- 성공 시 세션 쿠키 발급
  - Access Token: 1시간
  - Refresh Token: 7일
- 쿠키 방식(httpOnly)으로 저장

### 3.3 세션 유지
- API 호출이 401일 경우 자동 `/auth/refresh` 호출 후 재시도
- Refresh Token 만료 시 자동 로그아웃 처리

### 3.4 계정 관리
- 아이디 표시: 상단 고정 헤더에 아이디 표시
- 비밀번호 변경
  - 현재 비밀번호 확인
  - 변경 후 자동 재로그인
- 회원 탈퇴
  - 비밀번호 확인 후 삭제

### 3.5 관리자 계정
- 초기 관리자 계정 제공
  - 아이디: `admin`
  - 비밀번호: `admin`
- 로그인 후 비밀번호 변경 권장

## 4. 권한/역할
- 기본 역할: 사용자(`user`)
- 관리자 역할: `admin`
- 일반 사용자는 기본적으로 권한이 없음
- 관리자 권한 부여 후에만 각 기능(고정 지출/수입/요약)을 볼 수 있음

## 5. 고정 지출 관리
### 4.1 고정 지출 등록
- 입력 필드
  - 항목명
  - 총액
  - 월별 금액
  - 시작일
  - 종료일
  - 지급 방식: `single`(일시) / `installments`(분할)
  - 분할 횟수(선택)

### 4.2 고정 지출 조회
- 월별 조회: `YYYY-MM` 기준
- 기간(start_date ~ end_date) 내 포함되는 항목 조회

### 4.3 고정 지출 수정/삭제
- 로그인 사용자 범위 내에서만 변경/삭제 가능

## 6. 수입 관리
### 5.1 수입 등록
- 입력 필드
  - 항목명
  - 금액
  - 수입일

### 5.2 수입 조회
- 월별 조회: `YYYY-MM` 기준

### 5.3 수입 수정/삭제
- 로그인 사용자 범위 내에서만 변경/삭제 가능

## 7. 월 요약
- 월별 합산 제공
  - 총 수입
  - 총 고정 지출
  - 잔액(수입 - 고정지출)

## 8. UI 기능
- 로그인 전: 로그인/회원가입 폼 표시
- 로그인 후: 로그인/회원가입 폼 숨김
- 상단 고정 헤더에서 아이디 클릭 시 계정 관리 메뉴 표시
- 권한 없을 경우 기능 영역 숨김 및 안내 표시

## 9. 관리자 기능
- 사용자 목록 조회
- 사용자별 권한(고정지출/수입/요약) 설정
- 사용자 역할(관리자/사용자) 변경
- 월 기준일 설정(1~28)
  - 예: 15로 설정 시 15일~다음달 14일을 한 달로 집계
- 월 요약/고정 지출/수입 입력 및 조회 화면 제공

## 10. API 목록
### 인증
- `POST /auth/register` : 회원가입
- `POST /auth/login` : 로그인
- `POST /auth/refresh` : 토큰 갱신
- `POST /auth/logout` : 로그아웃
- `GET /auth/me` : 내 정보 조회
- `POST /auth/change-password` : 비밀번호 변경
- `POST /auth/delete-account` : 회원 탈퇴

### 관리자
- `GET /admin/users` : 사용자 목록
- `PUT /admin/users/:id/permissions` : 권한/역할 변경
- `GET /admin/settings` : 월 기준일 조회
- `PUT /admin/settings` : 월 기준일 변경

### 고정 지출
- `GET /fixed-expenses?month=YYYY-MM`
- `POST /fixed-expenses`
- `PUT /fixed-expenses/:id`
- `DELETE /fixed-expenses/:id`

### 수입
- `GET /incomes?month=YYYY-MM`
- `POST /incomes`
- `PUT /incomes/:id`
- `DELETE /incomes/:id`

### 요약
- `GET /summary?month=YYYY-MM`

## 11. 데이터 모델(요약)
- users: id, username, password_hash, created_at
- users.role: admin/user
- refresh_tokens: user_id, token_hash, expires_at, revoked_at
- user_permissions: user_id, can_view_fixed_expenses, can_view_incomes, can_view_summary
- app_settings: month_start_day
- fixed_expenses: user_id, name, total_amount_cents, per_month_cents, start_date, end_date, payment_type, installments_count
- incomes: user_id, name, amount_cents, income_date

## 12. 운영/배포
- Docker Compose로 API/DB 구동
- 외부 접속 포트: `8081`
- 초기 DB 생성: `schema.sql`
- 기존 DB 마이그레이션: `migrations/001_users_username.sql`
